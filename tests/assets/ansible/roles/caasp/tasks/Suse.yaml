---
- name: add repositories
  vars:
    repositories:
      caasp: http://download.suse.de/ibs/SUSE/Products/SUSE-CAASP/4.0/x86_64/product/
      caasp_updates: http://download.suse.de/ibs/SUSE/Updates/SUSE-CAASP/4.0/x86_64/update/
      suse_ca: "http://download.suse.de/ibs/SUSE:/CA/SLE_{{ ansible_distribution_major_version }}_SP{{ ansible_distribution_release }}/"
  zypper_repository:
    name: '{{ repo.key }}'
    repo: '{{ repo.value }}'
    state: present
    auto_import_keys: yes
  loop: "{{ lookup('dict', repositories) }}"
  loop_control:
    loop_var: repo

- name: add packages
  vars:
    pkg:
      - ca-certificates-suse
  zypper:
      name: '{{ pkg }}'
      state: present
      update_cache: yes

- name: set skuba-update to annotate-only mode
  copy:
    src: skuba-update
    dest: /etc/sysconfig/skuba-update
    owner: root
    group: root
    mode: 0644

- name: install skuba & kubectl
  zypper:
      name:
        - skuba
        - kubernetes-client
      state: present
      update_cache: no
  when: inventory_hostname in groups['first_master']

- name: retrieve skuba binary into workspace
  fetch:
    src: /usr/bin/skuba
    dest: '{{ rookcheck_workspace_dir }}/bin/'
    flat: yes
  when: inventory_hostname in groups['first_master']

- name: retrieve kubectl binary into workspace
  fetch:
    src: /usr/bin/kubectl
    dest: '{{ rookcheck_workspace_dir }}/bin/'
    flat: yes
  when: inventory_hostname in groups['first_master']

- name: make skuba binary executable
  file:
    path: '{{ rookcheck_workspace_dir }}/bin/skuba'
    mode: 0755
  delegate_to: 127.0.0.1
  when: inventory_hostname in groups['first_master']

- name: make kubectl binary executable
  file:
    path: '{{ rookcheck_workspace_dir }}/bin/kubectl'
    mode: 0755
  delegate_to: 127.0.0.1
  when: inventory_hostname in groups['first_master']

- name: remove skuba
  zypper:
      name: skuba
      state: absent
      update_cache: no
  when: inventory_hostname in groups['first_master']
